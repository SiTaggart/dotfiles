#!/bin/bash

# Set custom macOS defaults
# See: github.com/mathiasbynens/dotfiles

if [[ "$(uname -s)" != "Darwin" ]]; then
    printf "bin/osxdefaults: macOS only (Darwin).\n" >&2
    exit 0
fi

# NOTE: This file is intentionally conservative for modern macOS (Tahoe 26+).
# macOS changes preference domains/keys frequently; anything questionable should
# be left out rather than writing prefs that no longer apply.

# Close System Settings / System Preferences to avoid it overriding changes.
osascript -e 'tell application "System Settings" to quit' >/dev/null 2>&1 || true
osascript -e 'tell application "System Preferences" to quit' >/dev/null 2>&1 || true

write_default() {
    defaults write "$@" || printf "Warning: defaults write failed: %s\n" "$*" >&2
}

write_current_host_default() {
    defaults -currentHost write "$@" || printf "Warning: defaults -currentHost write failed: %s\n" "$*" >&2
}

# General UI/UX
# ----------------------------------------------------------------------

# Always show scrollbars
write_default NSGlobalDomain AppleShowScrollBars -string "Always"

# Save to disk (not to iCloud) by default
write_default NSGlobalDomain NSDocumentSaveNewDocumentsToCloud -bool false

# Automatically quit printer app once the print jobs complete
write_default com.apple.print.PrintingPrefs "Quit When Finished" -bool true

# Disable automatic termination of inactive apps
write_default NSGlobalDomain NSDisableAutomaticTermination -bool true

# Disable Resume system-wide
write_default NSGlobalDomain NSQuitAlwaysKeepsWindows -bool false

# Disable press-and-hold for keys in favor of key repeat
write_default NSGlobalDomain ApplePressAndHoldEnabled -bool false

# Set a blazingly fast keyboard repeat rate
write_default NSGlobalDomain KeyRepeat -int 1
write_default NSGlobalDomain InitialKeyRepeat -int 10

# Don’t automatically rearrange Spaces based on most recent use
write_default com.apple.dock mru-spaces -bool false


# Dock
# ----------------------------------------------------------------------

# Dock: position the Dock on the bottom
write_default com.apple.dock orientation -string "bottom"

# Automatically hide and show the Dock
write_default com.apple.dock autohide -bool true

# Dock: set the icon size of Dock items to 36 pixels
write_default com.apple.dock tilesize -int 36

# Dock: show indicator lights for open applications
write_default com.apple.dock show-process-indicators -bool true

# Dock: make icons of hidden applications translucent
write_default com.apple.dock showhidden -bool true

# Dock: don’t animate opening applications
write_default com.apple.dock launchanim -bool false

# Dock: use the scale effect for window minimizing
write_default com.apple.dock mineffect -string "scale"

# Dock: speed up Mission Control animations
write_default com.apple.dock expose-animation-duration -float 0.1


# Finder
# ----------------------------------------------------------------------

# Finder: show all filename extensions
write_default NSGlobalDomain AppleShowAllExtensions -bool true

# Finder: disable the warning when changing a file extension
write_default com.apple.finder FXEnableExtensionChangeWarning -bool false

# Finder: disable window and Get Info animations
write_default com.apple.finder DisableAllAnimations -bool true

# Finder: allow quitting via ⌘ + Q; doing so will also hide desktop icons
write_default com.apple.finder QuitMenuItem -bool true

# Finder: show the ~/Library folder (macOS)
chflags nohidden ~/Library

# Finder: show hidden files by default
write_default com.apple.finder AppleShowAllFiles -bool true

# Finder: use list view in all windows by default
# Four-letter codes for the other view modes: `icnv`, `clmv`, `Flwv`
write_default com.apple.finder FXPreferredViewStyle -string "Nlsv"

# Show icons for hard drives, servers, and removable media on the desktop
write_default com.apple.finder ShowExternalHardDrivesOnDesktop -bool true
write_default com.apple.finder ShowHardDrivesOnDesktop -bool true
write_default com.apple.finder ShowMountedServersOnDesktop -bool true
write_default com.apple.finder ShowRemovableMediaOnDesktop -bool true


# Panels
# ----------------------------------------------------------------------

# Panels: expand save panel by default
write_default NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
write_default NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true

# Panels: expand print panel by default
write_default NSGlobalDomain PMPrintingExpandedStateForPrint -bool true
write_default NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true

# Panels: LSQuarantine controls whether files downloaded by certain apps get a "quarantine"
# attribute. Disabling it weakens macOS security protections (Gatekeeper warnings).
# If you understand the trade-off, uncomment:
# write_default com.apple.LaunchServices LSQuarantine -bool false

# Panels: enable full keyboard access for all controls (e.g. enable Tab in modal dialogs)
write_default NSGlobalDomain AppleKeyboardUIMode -int 3


# Screen
# ----------------------------------------------------------------------

# Screen: require password immediately after sleep or screen saver begins
write_default com.apple.screensaver askForPassword -int 1
write_default com.apple.screensaver askForPasswordDelay -int 0

# Screen: save screenshots to ~/Desktop/Screenshots
mkdir -p "$HOME/Desktop/Screenshots"
write_default com.apple.screencapture location -string "$HOME/Desktop/Screenshots"

# Screen: disable shadow in screenshots
write_default com.apple.screencapture disable-shadow -bool true


# Disks
# ----------------------------------------------------------------------

# Disks: avoid creating .DS_Store files on network volumes
write_default com.apple.desktopservices DSDontWriteNetworkStores -bool true

# Disks: disable Time Machine prompts
write_default com.apple.TimeMachine DoNotOfferNewDisksForBackup -bool true

# Disks: disable disk image verification
# write_default com.apple.frameworks.diskimages skip-verify -bool true
# write_default com.apple.frameworks.diskimages skip-verify-locked -bool true
# write_default com.apple.frameworks.diskimages skip-verify-remote -bool true

# Safari
# ----------------------------------------------------------------------

# Press Tab to highlight each item on a web page
write_default com.apple.Safari WebKitTabToLinksPreferenceKey -bool true
write_default com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2TabsToLinks -bool true

# Show the full URL in the address bar (note: this still hides the scheme)
write_default com.apple.Safari ShowFullURLInSmartSearchField -bool true

# Enable the Develop menu and the Web Inspector in Safari
write_default com.apple.Safari IncludeDevelopMenu -bool true
write_default com.apple.Safari WebKitDeveloperExtrasEnabledPreferenceKey -bool true
write_default com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled -bool true

# iTerm2
# ----------------------------------------------------------------------

# Don’t display the annoying prompt when quitting iTerm
write_default com.googlecode.iterm2 PromptOnQuit -bool false

# Photos
# ----------------------------------------------------------------------

# Prevent Photos from opening automatically when devices are plugged in
write_current_host_default com.apple.ImageCapture disableHotPlug -bool true

###############################################################################
# Mac App Store                                                               #
###############################################################################

# Enable the automatic update check
write_default com.apple.SoftwareUpdate AutomaticCheckEnabled -bool true

# Download newly available updates in background
write_default com.apple.SoftwareUpdate AutomaticDownload -int 1

# Install System data files & security updates
write_default com.apple.SoftwareUpdate CriticalUpdateInstall -int 1


# Misc
# ----------------------------------------------------------------------

# Misc: disable Dictionary results
write_default com.apple.spotlight DictionaryLookupEnabled -bool false

# Misc: disable auto-correct
write_default NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false
# Disable smart quotes and smart dashes
write_default NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false
write_default NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false

for app in "Dock" "Finder" "Photos" "Safari" "SystemUIServer" "Terminal"; do
    killall "$app" >/dev/null 2>&1 || true
done
