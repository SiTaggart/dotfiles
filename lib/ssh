#!/bin/bash

run_ssh() {
#############################################
### Generate ssh keys & add to ssh-agent
### See: https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/
#############################################

echo "Generating SSH keys, adding to ssh-agent..."
read -r -p 'Input email for ssh key: ' useremail

mkdir -p "$HOME/.ssh"

local key_path="$HOME/.ssh/id_ed25519"
local pub_key_path="${key_path}.pub"

if [[ -f "${key_path}" ]]; then
    echo "SSH key already exists at ${key_path}. Skipping generation."
else
    echo "Use default ssh file location, enter a passphrase:"
    ssh-keygen -t ed25519 -C "$useremail" -f "${key_path}"
fi

eval "$(ssh-agent -s)"

# Add key to ssh-agent and store passphrase in keychain (macOS)
if ! ssh-add --apple-use-keychain "${key_path}" >/dev/null 2>&1; then
    ssh-add -K "${key_path}" >/dev/null 2>&1 || ssh-add "${key_path}"
fi

# Add macOS-specific ssh config if missing
if [[ -e "$HOME/.ssh/config" ]]; then
    echo "ssh config already exists. Skipping adding macOS-specific settings..."
else
    echo "Writing macOS-specific settings to ssh config..."
    cat <<'EOT' >> "$HOME/.ssh/config"
Host *
  AddKeysToAgent yes
  UseKeychain yes
  IdentityFile ~/.ssh/id_ed25519
EOT
fi

#############################################
### Add ssh-key to GitHub via GitHub CLI (preferred)
#############################################

if command -v gh >/dev/null 2>&1; then
    seek_confirmation "Add this SSH public key to GitHub now via GitHub CLI?"
    if is_confirmed; then
        read -r -p 'Machine name (title): ' ghtitle
        gh ssh-key add "${pub_key_path}" -t "${ghtitle}"
    fi
else
    echo "GitHub CLI (gh) not found. To add your key to GitHub, visit:"
    echo "  https://github.com/settings/ssh/new"
    echo "Public key:"
    cat "${pub_key_path}"
fi

}
