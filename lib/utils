#!/bin/bash

# Header logging
e_header() {
    printf "\n$(tput setaf 7)%s$(tput sgr0)\n" "$@"
}

# Step logging (alias for header)
step() {
    e_header "$@"
}

# Success logging
e_success() {
    printf "$(tput setaf 64)âœ“ %s$(tput sgr0)\n" "$@"
}

# Error logging
e_error() {
    printf "$(tput setaf 1)x %s$(tput sgr0)\n" "$@"
}

# Warning logging
e_warning() {
    printf "$(tput setaf 136)! %s$(tput sgr0)\n" "$@"
}

# Ask for confirmation before proceeding
seek_confirmation() {
    printf "\n"
    e_warning "$@"
    read -r -p "Continue? (y/n) " -n 1
    printf "\n"
}

# Test whether the result of an 'ask' is a confirmation
is_confirmed() {
    if [[ "$REPLY" =~ ^[Yy]$ ]]; then
      return 0
    fi
    return 1
}

# Test whether we're in a git repo
is_git_repo() {
    git rev-parse --is-inside-work-tree >/dev/null 2>&1
}

# Test whether a command exists
# $1 - cmd to test
type_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Test whether a Homebrew formula is already installed
# $1 - formula name (may include options)
formula_exists() {
    local formula_name="${1%% *}"

    if brew list --formula "$formula_name" >/dev/null 2>&1; then
        printf "%s already installed.\n" "$formula_name"
        return 0
    fi

    e_warning "Missing formula: $formula_name"
    return 1
}

# Test whether a Homebrew cask is already installed
# $1 - cask name
cask_exists() {
    if brew list --cask "$1" >/dev/null 2>&1; then
        printf "%s already installed.\n" "$1"
        return 0
    fi

    e_warning "Missing cask: $1"
    return 1
}

# Test whether a cask is installed via Homebrew OR the app exists in /Applications
# $1 - cask name
app_or_cask_exists() {
    # Already installed via brew?
    if brew list --cask "$1" >/dev/null 2>&1; then
        printf "%s already installed (via Homebrew).\n" "$1"
        return 0
    fi

    # Get the app name from brew's cask metadata (artifacts[].app[] contains "AppName.app")
    # JSON is pretty-printed, so collapse newlines first
    local app_file
    app_file=$(brew info --cask "$1" --json=v2 2>/dev/null | tr -d '\n' | grep -o '"app": \[[^]]*\]' | grep -o '"[^"]*\.app"' | head -1 | tr -d '"')

    # Check /Applications and ~/Applications
    if [[ -n "$app_file" ]]; then
        if [[ -d "/Applications/${app_file}" || -d "$HOME/Applications/${app_file}" ]]; then
            printf "%s already installed (found %s).\n" "$1" "$app_file"
            return 0
        fi
    fi

    # Fallback for PKG-based casks: use mdfind (Spotlight) to search by cask name
    # This catches apps like zoom (zoom.us.app) that don't have an app artifact
    local found_app
    found_app=$(mdfind "kMDItemKind == 'Application' && kMDItemFSName == '*${1}*'c" 2>/dev/null | head -1)
    if [[ -n "$found_app" ]]; then
        printf "%s already installed (found %s).\n" "$1" "$(basename "$found_app")"
        return 0
    fi

    e_warning "Missing cask: $1"
    return 1
}
