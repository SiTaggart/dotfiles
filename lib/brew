#!/bin/bash

run_brew() {

    # Check for Homebrew
    if type_exists 'brew'; then
        e_header "Updating Homebrew..."
        # Use the latest version of Homebrew
        brew update
        if [[ $? -eq 0 ]]; then e_success "Done"; fi

        e_header "Updating any existing Homebrew formulae..."
        # Upgrade any already-installed formulae
        brew upgrade
        if [[ $? -eq 0 ]]; then e_success "Done"; fi

        e_header "Checking status of desired Homebrew formulae..."
        local -a missing_formulae=()
        local -a desired_formulae=(
            'coreutils' # GNU core utilities (those that come with macOS are outdated)
            'git'
            'ack'
            'ripgrep'
            'bash'
            'bash-completion'
            'ffmpeg'
            'graphicsmagick'
            'jpeg'
            'node'
            'fnm'
            'optipng'
            'tree'
            'wget'
            'zsh'
            'zsh-completions'
            'zsh-autosuggestions'
            'gh'
            'mas'
            'postgresql'
            'grep'
            '1password-cli'
            'rsync'
        )

        for index in ${!desired_formulae[*]}
        do
            if ! formula_exists ${desired_formulae[$index]}; then
                # Store the name (and options) of every missing formula
                missing_formulae=("${missing_formulae[@]}" "${desired_formulae[$index]}")
            fi
        done

        if (( ${#missing_formulae[@]} )); then
            e_header "Installing missing Homebrew formulae: ${missing_formulae[*]}"
            brew install "${missing_formulae[@]}"
            if [[ $? -eq 0 ]]; then e_success "Done"; fi
        fi

        # Install Homebrew casks
        e_header "Checking status of desired Homebrew casks..."
        local -a missing_casks=()
        local -a desired_casks=(
            '1password'
            'ghostty'
            'docker'
            'visual-studio-code'
            'visual-studio-code@insiders'
            'notion'
            'obsidian'
            'imageoptim' # Changed from ImageOptim for consistency
            'raycast'
            'dropbox'
            'keycastr'
            'caffeine'
            'slack'
            'zoom'
            'hot'
            'pika'
            'loom'
            'rescuetime'
            'kap'
            'bruno'
            'rocket'
            'firefox'
            'google-chrome'
            'microsoft-edge'
            'discord'
            'chatgpt'
            'claude'
            'cursor'
            'figma'
        )

        for cask_name in ${desired_casks[*]}
        do
            if ! cask_exists $cask_name; then
                missing_casks+=("$cask_name")
            fi
        done

        if [[ ${#missing_casks[@]} -ne 0 ]]; then
            e_header "Installing missing Homebrew casks: ${missing_casks[*]}"
            brew install --cask "${missing_casks[@]}"
            if [[ $? -eq 0 ]]; then e_success "Done"; fi
        else
            e_success "All desired casks already installed."
        fi
        # Remove outdated versions from the Cellar
        brew cleanup
    else
        printf "\n"
        e_error "Error: Homebrew not found."
        printf "Aborting...\n"
        exit
    fi

}
